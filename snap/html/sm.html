<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QM: State Machines</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeDarkModeToggle.init()
    DoxygenAwesomeParagraphLink.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="spexy-awesome.css" rel="stylesheet" type="text/css"/>
<link href="qm.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
  <div id="projectlogo">
    <a href="https://www.state-machine.com" title="Quantum Leaps"><img alt="Logo" src="logo_ql.webp"/></a>
  </div>
   <div id="projectname">
    QM
    &nbsp;<span id="projectnumber">7.0.1</span>
   </div>
   <div id="projectbrief">Model-Based Design Tool</div>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;"
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('sm.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">State Machines</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><span class="prev_button"><a class="el" href="bm_lock.html">Locking Model Items</a></span><span class="next_button"><a class="el" href="sm_statechart.html">Working with Statecharts</a></span></p>
<p>This section focuses primarily on working with <b>state machine diagrams</b>, while Section <a class="el" href="ce_sm.html">Generating Code for State Machines</a> will cover <b>generating code</b> from state machines. Of course, these two aspects are related, so even while "simply drawing" state machine diagrams, you will need to take <a class="el" href="ce.html">code generation</a> into account.</p>
<h1><a class="anchor" id="sm_hsm"></a>
Hierarchical State Machines in QM</h1>
<p>QM provides extensive support for modern <a href="https://www.state-machine.com/fsm#HSM" target="_blank" rel="noopener">Hierarchical State Machines (HSMs)&uarr;</a> (UML Statecharts), which are perhaps the most effective and elegant technique of structuring event-driven systems. In fact, QM has been specifically designed for ease of diagramming HSMs and for <a class="el" href="ce_sm.html">generating efficient, production-quality code from them</a>.</p>
<dl class="section remark"><dt>Remarks</dt><dd>The section <a class="el" href="bm_diagram.html">Working with Diagrams</a> in the <a class="el" href="bm.html">Basic Modeling</a> part describes generic operations applicable to any diagram type, such as <a class="el" href="bm_diagram.html#bm_diagram_open">opening</a>, <a class="el" href="bm_diagram.html#bm_diagram_close">closing</a>, <a class="el" href="bm_diagram.html#bm_diagram_scroll">scrolling</a>, <a class="el" href="bm_diagram.html#bm_diagram_pan">panning</a>, and <a class="el" href="bm_diagram.html#bm_diagram_zoom">zooming</a> a diagram. The section <a class="el" href="sm_statechart.html">Working with Statecharts</a> describes specific operations applicable to statecharts (UML state diagrams).</dd></dl>
<p>The most important innovation of HSMs over classical finite state machines (FSMs) is the hierarchical state nesting. The value of state nesting lies in avoiding repetitions, which are inevitable in the traditional "flat" FSM formalism and are the main reason for the "state-transition explosion" in FSMs. The semantics of state nesting allow substates to define only the differences of behavior from the superstates, thus promoting sharing and reusing behavior.</p>
<dl class="section remark"><dt>Remarks</dt><dd>The Quantum Leaps Application Note <a href="https://www.state-machine.com/doc/AN_Crash_Course_in_UML_State_Machines.pdf" target="_blank" rel="noopener">A Crash Course in UML State Machines&uarr;</a> introduces the main state machine concepts backed up by examples. <div class="image">
<img src="AN_UML_State_Machines.png" alt=""/>
</div>
  <div class="caption"><center><em>Application Note: A Crash Course in UML State Machines</em></center></div></dd></dl>
<h1><a class="anchor" id="sm_class"></a>
State Machine Base Classes</h1>
<p>In QM a State Machine can be associated only with a <a class="el" href="bm_class.html">class</a> that is a direct or indirect subclass of the <a class="el" href="bm_model.html#bm_qp_item">QP Framework</a> base class <b>QHsm</b>, shown at the top of the class diagram <a class="el" href="#qp_classes-sm">below</a>.</p>
<p><a class="anchor" id="qp_classes-sm"></a></p><div class="image">
<img src="qp_sm.png" alt=""/>
</div>
  <div class="caption"><center><em>State Machine Classes in QP/C and QP/C++</em></center></div><p>The <b>QAsm</b> base class (<code>[1]</code> in the class diagram above) provides the basic interface <code>init()</code> and <code>dispatch()</code> for initializing a state machine and for dispatching events to it, respectively. The specific implementations of the state machine interface in the <b>QAsm</b> base class and its subclasses, such as <b>QHsm</b> <code>[2]</code>, <b>QMsm</b> <code>[3]</code>, <b>QActive</b> <code>[12]</code>, and <b>QMActive</b> <code>[13]</code>, determine the <a class="el" href="ce_sm.html#ce_sm_stra">state machine implementation strategy</a> that QM will apply to generate code.</p>
<dl class="section remark"><dt>Remarks</dt><dd>QM supports <b>classes</b> and <b>inheritance</b> regardless of the target programming language, which currently can be either C or C++. <a href="https://www.state-machine.com/oop" target="_blank" rel="noopener">Key Concept: Object-Oriented Programming in C&uarr;</a> describes how the <a href="https://www.state-machine.com/qpc" target="_blank" rel="noopener">QP/C&uarr;</a> framework as well as the <a class="el" href="ce_gen.html">QM code generator</a> implement <em>classes</em> and <em>inheritance</em> in portable <b>ISO C</b>.</dd></dl>
<h2><a class="anchor" id="sm_class_qhsm"></a>
QHsm-Based State Machines</h2>
<p>The <span style="background-color:#aaaaff"><b>QHsm</b></span> <code>[2]</code> and <span style="background-color:#aaaaff"><b>QActive</b></span> <code>[12]</code> classes from the <a class="el" href="#qp_classes-sm">class diagram above</a> implement the QHsm-based state machines that were originally designed for <b>manual coding</b> of HSMs, but now can also benefit from <a class="el" href="ce.html">automatic code generation by QM modeling tool</a>.</p>
<p>The screen shot below shows how to select the <b>superclass</b> property of your state-machine/active-object class in the <a class="el" href="bm_class.html#bm_class_prop">Class Property Sheet</a>, so that it uses the <code>QHsm/QActive</code>-based state machine implementation strategy:</p>
<div class="image">
<img src="sm_qhsm-based.png" alt=""/>
</div>
  <div class="caption"><center><em>Selecting QHsm/QActive base class (superclass)</em></center></div><p>The main advantage of QHsm-based state machine implementation is that the code is <b>highly readable</b> and human-maintainable, but it requires discovering the <em>transition-sequences</em> (sequences of exit/entry/initial actions) at run-time as opposed to code-generation time. Also, the state nesting in QHsm-based state machines is limited to 5 levels of nesting.</p>
<dl class="section remark"><dt>Remarks</dt><dd>You should consider <code>QHsm/QActive</code>-based state machines to get the highest readability of the generated code at some efficiency cost (compared to the <code>QMsm/QMActive</code>-based state machines).</dd></dl>
<h2><a class="anchor" id="sm_class_qmsm"></a>
QMsm/QMActive-Based State Machines</h2>
<p>The <span style="background-color:#ffaaaa;"><b>QMsm</b></span> <code>[3]</code> and <span style="background-color:#ffaaaa;"><b>QMActive</b></span> <code>[13]</code> classes from the <a class="el" href="#sm_class">class diagram above</a> re-implement the state machine interface and thus provide an alternative <a class="el" href="#sm_class_qmsm">QMsm/QMActive-Based State Machines</a> that is more efficient than the <a class="el" href="#sm_class_qhsm">QHsm-based strategy</a>, but requires the assistance of the QM tool (as an advanced "state machine compiler") to generate the complete <em>transition-sequences</em> at <em>code-generation</em> time. The resulting code is still <b>human-readable</b>, but is <b>not</b> suitable for manual coding or maintaining.</p>
<p>The screen shot below shows how to select the <b>superclass</b> property of your state-machine/active-object class in the <a class="el" href="bm_class.html#bm_class_prop">Class Property Sheet</a>, so that it uses the QMsm/QMActive-based state machine implementation strategy:</p>
<div class="image">
<img src="sm_qmsm-based.png" alt=""/>
</div>
  <div class="caption"><center><em>Selecting QMsm/QMActive base class (superclass)</em></center></div><p>The lab tests indicate that the <code>QMsm/QMActive</code>-based state machines can be about twice as fast as the <code>QHsm</code>-based state machines. (This pertains only to the boilerplate structural code for taking state transitions, but does not include application-specific action code, which typically dominates the execution time.) Additionally, the <code>QMsm/QMActive</code>-based state machines require less runtime support (smaller event processor) and use a bit less stack space for the <code>dispatch()</code> operation than <code>QHsm/QActive</code>-based state machines. Also, the state nesting in QMsm-based state machines is no longer limited (nesting levels as high as 10 levels have been tested).</p>
<dl class="section remark"><dt>Remarks</dt><dd>You should consider <code>QMsm/QMActive</code>-based state machines to get the highest performance at slightly less readable generated code.</dd></dl>
<h2><a class="anchor" id="sm_class-change"></a>
Changing State Machine Implementation</h2>
<p>To change state machine implementation strategy, you need to:</p>
<ol type="1">
<li>Select the <b>superclass</b> in the Property Sheet of your state machine class</li>
<li>Call the right <b>constructor</b> of your state machine class to call the matching base-class constructor, as illustrated in the screen shots below:</li>
</ol>
<div class="image">
<img src="sm_qhsm-ctor.png" alt=""/>
</div>
  <div class="caption"><center><em>Calling the QActive_ctor() in the subclass' constructor in C</em></center></div><p> <br  />
 </p><div class="image">
<img src="sm_qmsm-ctor.png" alt=""/>
</div>
  <div class="caption"><center><em>Calling the QMActive_ctor() in the subclass' constructor in C++</em></center></div><dl class="section attention"><dt>Attention</dt><dd>The two state machine implementation strategies have been designed to be <b>interchangeable</b>. Specifically, both strategies use the <em>same</em> state machine elements and the <em>same</em> syntax of <a class="el" href="ce_sm.html#ce_sm_act">actions</a> (entry/exit actions to states and actions on transitions), as described in the next section.</dd></dl>
<h1><a class="anchor" id="sm_toolbox"></a>
State Machine Toolbox</h1>
<p>When a State Machine diagram is active, the <a class="el" href="#sm_toolbox">State Machine Toolbox</a> displays a specific collection of tools for <b>adding</b> new shapes to the active State Machine.</p>
<dl class="section note"><dt>Note</dt><dd>The State Diagram Toolbox is <b>enabled</b> only when a state diagram is the active MDI window and the model is <a class="el" href="bm_lock.html">unlocked</a> (<span class="img unlock"></span>). If the Toolbox is <span class="highlight">invisible</span>, you need to show it in the <span class="menu"> View-&gt;Draw Toolbar</span> menu.</dd></dl>
<p>The usage of the tools in the State Diagram Toolbox is explained in the sections pertaining to the corresponding state machine elements:</p>
<ul>
<li><span class="img state"></span> <a class="el" href="sm_state.html">Add State</a></li>
<li><span class="img tran"></span> <a class="el" href="sm_tran.html">Add Transition</a></li>
<li><span class="img choice"></span> <a class="el" href="sm_choice.html">Add Choice Segment</a></li>
<li><span class="img initial"></span> <a class="el" href="sm_init.html">Add Initial Transition</a></li>
<li><span class="img history"></span> <a class="el" href="sm_hist.html">Add Transition to History</a></li>
</ul>
<p><span class="prev_button"><a class="el" href="bm_lock.html">Locking Model Items</a></span><span class="next_button"><a class="el" href="sm_statechart.html">Working with Statecharts</a></span> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2025 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QM 7.0.1</b> &nbsp;|&nbsp; created with <a title="Spexygen: traceable specifications" href="https://github.com/QuantumLeaps/spexygen"><em>Spexygen</em></a>
<hr class="footer"/><address class="footer"><small>
<a title="Quantum Leaps: Modern Embedded Software" href="https://www.state-machine.com">&copy; 2005-2025 Quantum Leaps</a> &nbsp;|&nbsp; <a title="help" href="help.html">Using Online Help</a> &nbsp;|&nbsp; <b>QM 7.0.1</b> &nbsp;|&nbsp; created with <a title="Spexygen: traceable specifications" href="https://github.com/QuantumLeaps/spexygen"><em>Spexygen</em></a>
</small></address>
    </li>
  </ul>
</div>
</body>
</html>
